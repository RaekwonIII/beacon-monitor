# Beacon Monitor

A TypeScript validator monitor for Ethereum beacon nodes built with [Bun](https://bun.sh) that integrates with the SSV (Secret Shared Validators) network to automatically register validators after activation.

This tool monitors validator status and polls every beacon chain epoch (6 minutes) to track activation epochs and other validator metadata. Upon validator activation, it automatically registers them with the SSV network.

## Features

- ‚úÖ Lightweight monitoring tool for validator public keys
- ‚úÖ Polls every epoch (43200 seconds = 12 minutes)
- ‚úÖ Persistent storage in `validators.json`
- ‚úÖ Supports multiple beacon nodes (Lighthouse, Teku, Prysm, Nimbus, Lodestar)
- ‚úÖ Automatically filters out already activated validators
- ‚úÖ Console logging on validator activation events
- ‚úÖ Automatic registration with SSV network upon validator activation
- ‚úÖ Integration with SSV SDK for validator registration

## Installation

**Prerequisites**:
- [Bun](https://bun.sh) installation ([`bun -v`](https://bun.sh/docs/installation))
- [TypeScript](https://www.typescriptlang.org/) (included with Bun)

**Setup**:

1. Navigate to the project directory:
   ```bash
   cd beacon-monitor
   ```

2. Install dependencies (Bun typically handles this automatically):
   ```bash
   bun install
   ```

3. Set up environment configuration:
   ```bash
   cp .env.example .env
   # Edit .env with your beacon node URL and SSV configuration
   ```

**Usage**:

Basic usage with keyshares.json file (loads validators from SSV keyshares):
```bash
bun run dev
```

## Configuration

### Environment Variables

**Required**:
- `BEACON_NODE_URL`: Protocol + host + port of beacon node
  - Format: `http://localhost:5052`
  - Format: `https://mainnet-beacon.beaconcha.in`
  - Format: `http://your-node:5052`

**SSV Configuration** (needed for automatic registration):
- `PRIVATE_KEY`: Wallet private key for SSV registration
- `CHAIN`: Ethereum network (hoodi or mainnet)
- `SUBGRAPH_ENDPOINT`: SSV subgraph endpoint
- `SUBGRAPH_API_KEY`: SSV subgraph API key
- `KEYSHARES_FILE`: Path to keyshares.json file (default: ./keyshares.json)

### Project Structure

```
beacon-monitor/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ types.ts         # TypeScript interfaces and types
‚îÇ   ‚îú‚îÄ‚îÄ beacon-client.ts  # API client with polling logic
‚îÇ   ‚îú‚îÄ‚îÄ storage.ts        # File persistence utilities
‚îÇ   ‚îú‚îÄ‚îÄ utils.ts          # Utility functions including SSV SDK initialization
‚îÇ   ‚îú‚îÄ‚îÄ main.ts          # CLI entry point
‚îÇ   ‚îú‚îÄ‚îÄ deposit.ts        # Deposit related functions (if used)
‚îÇ   ‚îú‚îÄ‚îÄ generate.ts       # Keyshares generation functions (if used)
‚îÇ   ‚îî‚îÄ‚îÄ depositABI.ts     # Deposit ABI (if used)
‚îú‚îÄ‚îÄ keyshares.json       # SSV keyshares file with validator information (Generated by the tool)
‚îú‚îÄ‚îÄ .env.example         # Template for environment variables
‚îú‚îÄ‚îÄ .gitignore           # Git ignore patterns
‚îú‚îÄ‚îÄ package.json        # Project configuration
‚îú‚îÄ‚îÄ tsconfig.json       # TypeScript compiler configuration
‚îú‚îÄ‚îÄ validators.json     #  Tracks monitored validators (Generated by the tool)
‚îî‚îÄ‚îÄ README.md           # This file
```

### Storage File (`validators.json`)

The tool automatically generates and maintains a `validators.json` file:

```json
{
  "0x123abc...": "pending_queued",
  "0x456def...": "active_ongoing"
}
```

**Note**: This file is persistent and tracks all monitored validators and their statuses.

## Monitoring Logic

The tool monitors validators with the following workflow:

1. **Startup**: Load validators from keyshares.json file
2. **Storage**: Save validators to `validators.json` with status `pending_queued`
3. **Polling**: Every 12 minutes, fetch validator statuses from beacon node API
4. **Status Comparison**: Compare new statuses with stored statuses
5. **Activation Detection**: When `pending_queued` ‚Üí `active_ongoing`:
   - Log in format: `‚úÖ Activated: pubkey: 0x..., activation_epoch: 16141`
   - Register validator with SSV network using keyshares
   - Remove validator from next poll
   - Update `validators.json`
6. **Complete Monitoring**: When all validators are activated, clear `validators.json` and exit

### API Endpoint

The tool queries the beacon node API endpoint:
```
GET {BEACON_NODE_URL}/eth/v1/beacon/states/head/validators?status=...&id={pubkey1}&id={pubkey2}...
```

This endpoint returns validator statuses and metadata including:
- `pubkey`: Validator public key
- `activation_epoch`: Epoch when validator became active
- `status`: Current validator status
- `balance`: Current validator balance
- `exit_epoch`: Epoch when validator will exit
- `withdrawable_epoch`: Epoch when validator can withdraw

## SSV Integration

The tool integrates with the SSV network for validator registration:
- Uses SSV SDK to register validators
- Automatically detects activated validators from beacon node
- Registers validators with SSV network in bulk
- Handles transaction management with SSV network

## Logging Format

The tool logs the following messages:

### Activation Event
```
‚úÖ Activated: pubkey: 0x123abc..., activation_epoch: 16141
```

### Status Updates
```
üíæ Saved validator statuses to validators.json
```

### SSV Registration
```
‚úÖ Found 1 activated validators to register
üîÑ Registering 1 validators with SSV network...
‚úÖ Successfully registered validators, tx hash: 0x...
```

### Errors
```
‚ùå Error during polling: Failed to fetch validators: HTTP error! status: 503
‚ùå Failed to register validators: Error message
```

## Error Handling

The tool handles various error scenarios:

- **Invalid pubkey format**: Exits with error message
- **Network errors**: Retries once, logs errors, continues next epoch
- **File I/O errors**: Returns empty storage state
- **SSV registration errors**: Logs errors and continues monitoring
- **Graceful shutdown**: Allows Ctrl+C to exit cleanly

## Dependencies

- **Native Bun features**: No external dependencies required
- **TypeScript**: Built-in TypeScript support
- **SSV SDK**: For validator registration with SSV network
- **viem**: For Ethereum interaction

## Example: Local Beacon Node with SSV Registration

```bash
cd beacon-monitor
export BEACON_NODE_URL=http://localhost:5052
export PRIVATE_KEY=your_private_key_here
export CHAIN=mainnet
export SUBGRAPH_ENDPOINT=https://subgraph.ssv.network
export SUBGRAPH_API_KEY=your_api_key_here
export KEYSHARES_FILE=./keyshares.json
bun run dev
```

## Troubleshooting

### Issue: "BEACON_NODE_URL environment variable is required"

**Solution**: Set the environment variable before running:
```bash
export BEACON_NODE_URL=http://localhost:5052
bun run dev
```

Or include it inline:
```bash
BEACON_NODE_URL=http://localhost:5052 bun run dev
```

### Issue: "No valid validator data in response"

**Solution**: Check that your beacon node is accessible and providing valid data. Verify the BEACON_NODE_URL is correct and the node is running.

### Issue: "No validators to monitor. Exiting"

**Solution**: The system found no pending validators to monitor. Check if validators.json exists and contains valid data.

### Issue: "All pending validators have been activated!"

**Solution**: The system detected that all watched validators have been activated. Clear validators.json and restart with new pending validators:

```bash
rm validators.json
export BEACON_NODE_URL=http://localhost:5052
export PRIVATE_KEY=your_private_key_here
export CHAIN=mainnet
export SUBGRAPH_ENDPOINT=https://subgraph.ssv.network
export SUBGRAPH_API_KEY=your_api_key_here
export KEYSHARES_FILE=./keyshares.json
bun run dev
```

## License

MIT

## Contributing

This is a standalone monitoring tool. For contributing to Ethereum validator infrastructure, refer to the official resources and community-driven projects.

## Support

For issues related to beacon node functionality, consult the beacon node's documentation:
- [Lighthouse](https://github.com/sigp/lighthouse)
- [Teku](https://github.com/ConsenSys/teku)
- [Prysm](https://docs.prylabs.network/)
- [Nimbus](https://github.com/status-im/nimbus-eth2)
- [Lodestar](https://github.com/ChainSafe/lodestar)